name: Pull Request Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    name: Label PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Apply labels based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

      - name: Apply size label
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;

            // Remove existing size labels
            const existingLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const sizeLabels = existingLabels.data
              .filter(label => label.name.startsWith('size/'))
              .map(label => label.name);

            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: label
              });
            }

            // Determine size label
            let sizeLabel = 'size/XS';
            if (totalChanges > 1000) sizeLabel = 'size/XXL';
            else if (totalChanges > 500) sizeLabel = 'size/XL';
            else if (totalChanges > 250) sizeLabel = 'size/L';
            else if (totalChanges > 100) sizeLabel = 'size/M';
            else if (totalChanges > 30) sizeLabel = 'size/S';

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });

      - name: Apply type label from PR title
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            // Extract type from conventional commit format
            const match = title.match(/^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?:/);

            if (match) {
              const type = match[1];
              const typeLabel = `type/${type}`;

              // Check if label exists in repo
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: typeLabel
                });

                // Add the label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [typeLabel]
                });
              } catch (error) {
                console.log(`Label ${typeLabel} does not exist, skipping`);
              }
            }
